<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TaskMaster — Night City</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Chakra+Petch:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg0:#06070a; --bg1:#0b0f1a; --grid:rgba(0,255,255,.06);
      --card:rgba(9,13,24,.65); --text:#def3ff; --muted:#7aa2b8;
      --accent:#00e5ff; --accent-2:#f8ff2a; --danger:#ff2975;
      --glow:0 0 20px rgba(0,229,255,.45), 0 0 40px rgba(0,229,255,.25);
      --glow-yellow:0 0 20px rgba(248,255,42,.45), 0 0 40px rgba(248,255,42,.25);
    }
    *{ box-sizing:border-box; } html,body{ height:100%; }
    body{
      margin:0; color:var(--text);
      font-family:"Chakra Petch", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(0,229,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(248,255,42,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      display:flex; align-items:flex-start; justify-content:center;
      padding:48px 18px; overflow-x:hidden; position:relative; isolation:isolate;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0, rgba(255,255,255,.04) 1px, transparent 2px, transparent 4px),
        linear-gradient(180deg, transparent 0, transparent 40%, rgba(0,0,0,.25));
      mix-blend-mode:soft-light; pointer-events:none; animation:scan 12s linear infinite;
    }
    body::after{
      content:""; position:fixed; inset:0; z-index:-3;
      background:
        linear-gradient(transparent, transparent),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px),
        linear-gradient(0deg, var(--grid) 1px, transparent 1px);
      background-size:100% 100%,64px 64px,64px 64px;
      mask:linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.6));
      pointer-events:none;
    }
    @keyframes scan{0%{transform:translateY(-10px);opacity:.85}50%{transform:translateY(0);opacity:.7}100%{transform:translateY(-10px);opacity:.85}}

    .container{
      width:100%; max-width:920px; background:var(--card);
      border:1px solid rgba(0,229,255,.18); border-radius:16px;
      box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(0,229,255,.08);
      backdrop-filter:blur(8px); padding:26px; position:relative;
    }
    .topbar{ display:flex; align-items:center; gap:14px; margin-bottom:8px; }
    h1{
      margin:0; font-family:"Orbitron", sans-serif; font-weight:700; letter-spacing:.04em;
      font-size:28px; color:var(--accent-2); text-shadow:var(--glow-yellow);
      position:relative; animation: glitch 2s infinite;
    }
    h1::before, h1::after{
      content:attr(data-text); position:absolute; left:0; top:0; width:100%;
      overflow:hidden; clip:rect(0,900px,0,0);
    }
    h1::before{ color:var(--accent); animation:glitchTop 2s infinite; }
    h1::after{ color:var(--danger); animation:glitchBottom 2s infinite; }
    @keyframes glitch{
      0%{text-shadow:var(--glow-yellow)} 20%{text-shadow:2px 0 var(--accent), -2px -2px var(--danger)}
      40%{text-shadow:-2px -2px var(--accent), 2px 2px var(--danger)}
      60%{text-shadow:2px 2px var(--accent), -2px 0 var(--danger)}
      80%{text-shadow:-2px 0 var(--accent), 2px -2px var(--danger)} 100%{text-shadow:var(--glow-yellow)}
    }
    @keyframes glitchTop{0%{clip:rect(0,9999px,0,0)}10%{clip:rect(0,9999px,20px,0);transform:translate(-2px,-2px)}20%{clip:rect(0,9999px,0,0)}30%{clip:rect(0,9999px,15px,0);transform:translate(2px,-1px)}40%{clip:rect(0,9999px,0,0)}}
    @keyframes glitchBottom{0%{clip:rect(0,9999px,0,0)}50%{clip:rect(10px,9999px,9999px,0);transform:translate(2px,2px)}60%{clip:rect(0,9999px,0,0)}70%{clip:rect(20px,9999px,9999px,0);transform:translate(-2px,1px)}80%{clip:rect(0,9999px,0,0)}}

    .badge{
      font-family:"Orbitron", sans-serif; font-size:12px; letter-spacing:.12em;
      color:#001314; background:linear-gradient(90deg, var(--accent-2), #ffd600);
      border-radius:999px; padding:6px 10px; box-shadow:var(--glow-yellow); transform:skewX(-8deg);
    }
    .muted{ color:var(--muted); margin:6px 0 16px; }
    .row{ display:flex; gap:10px; }
    input[type="text"]{
      flex:1; padding:12px 14px; border-radius:10px; border:1px solid rgba(0,229,255,.35);
      background:rgba(0,10,18,.6); color:var(--text); outline:none;
      transition:border-color .2s, box-shadow .2s; box-shadow:inset 0 0 0 1px rgba(0,229,255,.08);
    }
    input[type="text"]::placeholder{ color:#7bd4e6; opacity:.6; }
    input[type="text"]:focus{ border-color:var(--accent); box-shadow:var(--glow); }
    button{
      border:0; padding:12px 16px; border-radius:10px; cursor:pointer;
      font-weight:700; font-family:"Orbitron", sans-serif; letter-spacing:.06em;
      transition:transform .05s ease, box-shadow .2s ease, filter .2s;
    }
    .btn-add{ background:linear-gradient(90deg, var(--accent), #00ffd5); color:#001015; box-shadow:var(--glow); }
    .btn-add:active{ transform:translateY(1px) scale(.99); filter:brightness(.9); }
    .btn-del{ background:linear-gradient(90deg, #ff2975, #ff5ea8); color:#14000a; box-shadow:0 0 16px rgba(255,41,117,.35); }

    .columns{ display:grid; grid-template-columns: 1fr 1fr; gap:24px; }
    @media (max-width: 900px){ .columns{ grid-template-columns: 1fr; } }

    /* Task list */
    ul{ list-style:none; padding:0; margin:18px 0 0; }
    li{ display:flex; align-items:center; gap:12px; padding:12px 10px; border-bottom:1px dashed rgba(0,229,255,.18); }
    li:last-child{ border-bottom:none; }
    li.completed .desc{ color:#78a4b5; text-decoration:line-through; }
    .desc{ flex:1; word-break:break-word; }

    .divider{ margin:22px 0; border:none; height:1px; background:linear-gradient(90deg, transparent, rgba(0,229,255,.35), transparent); }
    .error{ color:#ff8fb7; margin-top:8px; white-space:pre-wrap; }

    /* Chat UI */
    .chatCard{
      background:rgba(0,10,18,.65); border:1px solid rgba(0,229,255,.18);
      border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px;
      min-height:360px;
    }
    .chatWindow{
      border:1px solid rgba(0,229,255,.15);
      border-radius:10px; padding:12px; background:rgba(0,0,0,.25);
      height:300px; overflow:auto;
      box-shadow: inset 0 0 20px rgba(0,0,0,.35);
    }
    .msg{ display:flex; gap:8px; margin-bottom:10px; align-items:flex-end; max-width:85%; }
    .msg.user{ margin-left:auto; flex-direction:row-reverse; }
    .avatar{
      width:28px; height:28px; border-radius:50%;
      background: linear-gradient(180deg, #00e5ff, #00a3ff);
      box-shadow: 0 0 8px rgba(0,229,255,.6);
      position:relative;
    }
    .avatar.bot{
      background: linear-gradient(180deg, #f8ff2a, #e7f000);
      box-shadow: 0 0 8px rgba(248,255,42,.6);
    }
    .avatar.bot::after{
      content:"J";
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:#141400; font-weight:900; font-family:"Orbitron", sans-serif;
    }
    .bubble{
      padding:10px 12px; border-radius:12px; line-height:1.35;
      border:1px solid rgba(0,229,255,.2); background:rgba(0,25,30,.6);
      box-shadow: 0 4px 14px rgba(0,0,0,.25);
    }
    .user .bubble{ border-color: rgba(255,41,117,.3); background:rgba(51,0,24,.6); }
    .meta{ font-size:11px; color:#7aa2b8; margin-top:4px; }
    .typing{ display:flex; gap:4px; align-items:center; padding:8px 10px; }
    .dot{ width:6px; height:6px; border-radius:50%; background:#9beaff; opacity:.6; animation:blink 1.2s infinite; }
    .dot:nth-child(2){ animation-delay:.2s } .dot:nth-child(3){ animation-delay:.4s }
    @keyframes blink{ 0%,60%,100%{ opacity:.2 } 30%{ opacity:1 } }

    /* Dev console toggle */
    .switch{ display:inline-flex; align-items:center; gap:8px; user-select:none; cursor:pointer; }
    .switch input{ display:none; }
    .track{
      width:46px; height:26px; border-radius:999px; position:relative;
      background:rgba(0,229,255,.25); border:1px solid rgba(0,229,255,.35);
      box-shadow:inset 0 0 8px rgba(0,0,0,.5); transition:background .2s;
    }
    .knob{
      position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%;
      background:linear-gradient(180deg,#fff,#b7fff9); box-shadow:0 0 10px rgba(0,229,255,.6);
      transition:left .2s;
    }
    .switch input:checked + .track{ background:rgba(248,255,42,.45); box-shadow:var(--glow-yellow); }
    .switch input:checked + .track .knob{ left:22px; }
    #consoleWrap{ display:none; margin-top:10px; }
    #consoleWrap.show{ display:block; }

    input[type="checkbox"]{ width:18px; height:18px; cursor:pointer; accent-color:#00ffd5; filter:drop-shadow(0 0 6px rgba(0,229,255,.6)); }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1 data-text="TASKMASTER">TASKMASTER</h1>
      <span class="badge">NIGHT CITY BUILD</span>
    </div>
    <div class="muted"><span id="count">0</span> contracts on your deck</div>

    <div class="columns">
      <!-- Tasks -->
      <div>
        <div class="row">
          <input id="newTask" type="text" placeholder='Queue a contract… (e.g., "Ping the netrunner")' />
          <button id="addBtn" class="btn-add">Add</button>
        </div>
        <ul id="taskList"></ul>
      </div>

      <!-- Chatbot -->
      <div>
        <div class="chatCard">
          <div class="row">
            <input id="chatInput" type="text" placeholder='Try: add "buy cyberware", delete the third one, I’m done with task 2…' />
            <button id="chatSend" class="btn-add">Send</button>
          </div>

          <div class="chatWindow" id="chatWindow"></div>

          <div class="row" style="justify-content:space-between; align-items:center;">
            <div class="muted">Dev Mode (show AI function call JSON)</div>
            <label class="switch">
              <input id="devToggle" type="checkbox" />
              <span class="track"><span class="knob"></span></span>
            </label>
          </div>
          <div id="consoleWrap">
            <pre id="chatLog"></pre>
          </div>

          <div id="err" class="error" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "/api/tasks";
    const PG_MODE = false; // set true for cleaner Johnny lines

    const els = {
      list: document.getElementById("taskList"),
      count: document.getElementById("count"),
      input: document.getElementById("newTask"),
      add: document.getElementById("addBtn"),
      chatInput: document.getElementById("chatInput"),
      chatSend: document.getElementById("chatSend"),
      chatWindow: document.getElementById("chatWindow"),
      chatLog: document.getElementById("chatLog"),
      err: document.getElementById("err"),
      devToggle: document.getElementById("devToggle"),
      consoleWrap: document.getElementById("consoleWrap"),
    };

    els.devToggle.addEventListener("change", () => {
      els.consoleWrap.classList.toggle("show", els.devToggle.checked);
    });

    const json = async (res) => {
      if (!res.ok) {
        let msg = "Request failed";
        try { const d = await res.json(); msg = d.error || JSON.stringify(d); } catch {}
        throw new Error(msg);
      }
      return res.json();
    };

    let lastRendered = "";
    function renderTasks(tasks){
      const snap = JSON.stringify(tasks);
      if (snap === lastRendered) return;
      lastRendered = snap;

      els.count.textContent = tasks.length;
      els.list.innerHTML = "";
      if (!tasks.length){
        els.list.innerHTML = `<div class="muted" style="padding:8px;">No tasks yet — add your first one!</div>`;
        return;
      }
      for (const t of tasks){
        const li = document.createElement("li");
        li.className = t.completed ? "completed" : "";
        li.innerHTML = `
          <input type="checkbox" ${t.completed ? "checked disabled" : ""} data-id="${t.id}">
          <span class="desc"></span>
          <button class="btn-del" data-id="${t.id}">Delete</button>
        `;
        li.querySelector(".desc").textContent = t.description;
        els.list.appendChild(li);
      }
    }

    async function loadTasks(){
      try{
        const data = await fetch(API_BASE).then(json);
        renderTasks(data);
        els.err.textContent = "";
      }catch(e){ els.err.textContent = e.message; }
    }

    async function addTask(desc){
      const body = { description: String(desc||"").trim() };
      if(!body.description) return;
      els.input.value = "";
      try{
        await fetch(API_BASE, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(body)
        }).then(json);
        await loadTasks();
      }catch(e){ els.err.textContent = e.message; }
    }

    async function completeTask(id){
      try{ await fetch(`${API_BASE}/${id}/complete`, { method:"PATCH" }).then(json); await loadTasks(); }
      catch(e){ els.err.textContent = e.message; }
    }

    async function deleteTask(id){
      try{ await fetch(`${API_BASE}/${id}`, { method:"DELETE" }).then(json); await loadTasks(); }
      catch(e){ els.err.textContent = e.message; }
    }

    els.add.addEventListener("click", () => addTask(els.input.value));
    els.input.addEventListener("keydown", e => { if(e.key==="Enter") addTask(els.input.value); });
    els.list.addEventListener("click", e => {
      const btn = e.target.closest(".btn-del");
      if (btn) return deleteTask(btn.dataset.id);
      if (e.target.type === "checkbox" && !e.target.disabled) return completeTask(e.target.dataset.id);
    });

    // Chat UI helpers
    function nowTime(){
      const d = new Date();
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    function appendMsg(text, who="bot"){
      const wrap = document.createElement("div");
      wrap.className = `msg ${who}`;
      const avatar = document.createElement("div");
      avatar.className = `avatar ${who==="bot"?"bot":""}`;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = nowTime();

      wrap.appendChild(avatar);
      const col = document.createElement("div");
      col.style.maxWidth = "100%";
      col.appendChild(bubble);
      col.appendChild(meta);
      wrap.appendChild(col);

      if (who === "user") wrap.style.marginLeft = "auto";
      els.chatWindow.appendChild(wrap);
      els.chatWindow.scrollTop = els.chatWindow.scrollHeight;
    }
    let typingRow = null;
    function showTyping(){
      typingRow = document.createElement("div");
      typingRow.className = "msg";
      const avatar = document.createElement("div");
      avatar.className = "avatar bot";
      const bubble = document.createElement("div");
      bubble.className = "bubble typing";
      bubble.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
      typingRow.appendChild(avatar);
      const col = document.createElement("div");
      col.appendChild(bubble);
      typingRow.appendChild(col);
      els.chatWindow.appendChild(typingRow);
      els.chatWindow.scrollTop = els.chatWindow.scrollHeight;
    }
    function hideTyping(){
      if (typingRow && typingRow.parentNode) typingRow.parentNode.removeChild(typingRow);
      typingRow = null;
    }

    function silverhandQuip(){
      const clean = [
        "Rock 'n' roll. Let's move.",
        "Consider it done, rebel.",
        "Chrome up your act, choom.",
        "Another contract burned."
      ];
      const spicy = [
        "Another day, another corpo chore torched.",
        "Alright, samurai — let’s burn this list.",
        "Marked it. Try not to flatline this time.",
        "Gone. Like Arasaka’s ethics."
      ];
      const pool = PG_MODE ? clean : spicy;
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function johnnyLine(call, tasks){
      if (!call || !call.function) return "Router glitched. Showing your docket.";
      const fn = call.function;
      const p  = call.parameters || {};
      if (fn === "addTask")       return `Added “${p.description}”. ${silverhandQuip()}`;
      if (fn === "completeTask")  return `Checked off task #${p.task_id}. ${silverhandQuip()}`;
      if (fn === "deleteTask")    return `Deleted task #${p.task_id}. ${silverhandQuip()}`;
      if (fn === "viewTasks") {
        const n = Array.isArray(tasks) ? tasks.length : 0;
        return n === 0
          ? `Your list’s emptier than a corpo promise.`
          : `You’ve got ${n} contract${n>1?"s":""} left. ${silverhandQuip()}`;
      }
      return `Done. ${silverhandQuip()}`;
    }

    async function chatSend(){
      const text = els.chatInput.value.trim();
      if(!text) return;
      els.chatInput.value = "";
      appendMsg(text, "user");
      showTyping();
      try{
        const data = await fetch("/api/ai", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ text })
        }).then(json);

        if (els.devToggle.checked) {
          els.chatLog.textContent = JSON.stringify(data.call, null, 2) + "\n\n" + (els.chatLog.textContent || "");
        }

        renderTasks(data.tasks || []);
        hideTyping();
        appendMsg(johnnyLine(data.call, data.tasks), "bot");
        els.err.textContent = "";
      }catch(err){
        hideTyping();
        appendMsg("⚠️ AI call failed. Check your key or server logs.", "bot");
        els.err.textContent = err.message || "AI call failed";
      }
    }
    els.chatSend.addEventListener("click", chatSend);
    els.chatInput.addEventListener("keydown", e => { if(e.key==="Enter") chatSend(); });

    loadTasks();
  </script>
</body>
</html>
